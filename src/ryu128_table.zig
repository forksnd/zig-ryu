// Copyright 2018 Ulf Adams
//
// The contents of this file may be used under the terms of the Apache License,
// Version 2.0.
//
//    (See accompanying file LICENSE-Apache or copy at
//     http://www.apache.org/licenses/LICENSE-2.0)
//
// Alternatively, the contents of this file may be used under the terms of
// the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE-Boost or copy at
//     https://www.boost.org/LICENSE_1_0.txt)
//
// Unless required by applicable law or agreed to in writing, this software
// is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.

const std = @import("std");
const helper = @import("ryu128_helper.zig");

pub const f128_pow5_inv_bitcount = 249;
pub const f128_pow5_bitcount = 249;

// These tables are ~4.5 kByte total, compared to ~160 kByte for the full tables.

// There's no way to define 128-bit constants in C, so we use little-endian
// pairs of 64-bit constants.
const generic_pow5_table = [_][]const u64{
    &[_]u64{ 1, 0 },
    &[_]u64{ 5, 0 },
    &[_]u64{ 25, 0 },
    &[_]u64{ 125, 0 },
    &[_]u64{ 625, 0 },
    &[_]u64{ 3125, 0 },
    &[_]u64{ 15625, 0 },
    &[_]u64{ 78125, 0 },
    &[_]u64{ 390625, 0 },
    &[_]u64{ 1953125, 0 },
    &[_]u64{ 9765625, 0 },
    &[_]u64{ 48828125, 0 },
    &[_]u64{ 244140625, 0 },
    &[_]u64{ 1220703125, 0 },
    &[_]u64{ 6103515625, 0 },
    &[_]u64{ 30517578125, 0 },
    &[_]u64{ 152587890625, 0 },
    &[_]u64{ 762939453125, 0 },
    &[_]u64{ 3814697265625, 0 },
    &[_]u64{ 19073486328125, 0 },
    &[_]u64{ 95367431640625, 0 },
    &[_]u64{ 476837158203125, 0 },
    &[_]u64{ 2384185791015625, 0 },
    &[_]u64{ 11920928955078125, 0 },
    &[_]u64{ 59604644775390625, 0 },
    &[_]u64{ 298023223876953125, 0 },
    &[_]u64{ 1490116119384765625, 0 },
    &[_]u64{ 7450580596923828125, 0 },
    &[_]u64{ 359414837200037393, 2 },
    &[_]u64{ 1797074186000186965, 10 },
    &[_]u64{ 8985370930000934825, 50 },
    &[_]u64{ 8033366502585570893, 252 },
    &[_]u64{ 3273344365508751233, 1262 },
    &[_]u64{ 16366721827543756165, 6310 },
    &[_]u64{ 8046632842880574361, 31554 },
    &[_]u64{ 3339676066983768573, 157772 },
    &[_]u64{ 16698380334918842865, 788860 },
    &[_]u64{ 9704925379756007861, 3944304 },
    &[_]u64{ 11631138751360936073, 19721522 },
    &[_]u64{ 2815461535676025517, 98607613 },
    &[_]u64{ 14077307678380127585, 493038065 },
    &[_]u64{ 15046306170771983077, 2465190328 },
    &[_]u64{ 1444554559021708921, 12325951644 },
    &[_]u64{ 7222772795108544605, 61629758220 },
    &[_]u64{ 17667119901833171409, 308148791101 },
    &[_]u64{ 14548623214327650581, 1540743955509 },
    &[_]u64{ 17402883850509598057, 7703719777548 },
    &[_]u64{ 13227442957709783821, 38518598887744 },
    &[_]u64{ 10796982567420264257, 192592994438723 },
    &[_]u64{ 17091424689682218053, 962964972193617 },
    &[_]u64{ 11670147153572883801, 4814824860968089 },
    &[_]u64{ 3010503546735764157, 24074124304840448 },
    &[_]u64{ 15052517733678820785, 120370621524202240 },
    &[_]u64{ 1475612373555897461, 601853107621011204 },
    &[_]u64{ 7378061867779487305, 3009265538105056020 },
    &[_]u64{ 18443565265187884909, 15046327690525280101 },
};

const generic_pow5_split = [_][]const u64{
    &[_]u64{ 0, 0, 0, 72057594037927936 },
    &[_]u64{ 0, 5206161169240293376, 4575641699882439235, 73468396926392969 },
    &[_]u64{ 3360510775605221349, 6983200512169538081, 4325643253124434363, 74906821675075173 },
    &[_]u64{ 11917660854915489451, 9652941469841108803, 946308467778435600, 76373409087490117 },
    &[_]u64{ 1994853395185689235, 16102657350889591545, 6847013871814915412, 77868710555449746 },
    &[_]u64{ 958415760277438274, 15059347134713823592, 7329070255463483331, 79393288266368765 },
    &[_]u64{ 2065144883315240188, 7145278325844925976, 14718454754511147343, 80947715414629833 },
    &[_]u64{ 8980391188862868935, 13709057401304208685, 8230434828742694591, 82532576417087045 },
    &[_]u64{ 432148644612782575, 7960151582448466064, 12056089168559840552, 84148467132788711 },
    &[_]u64{ 484109300864744403, 15010663910730448582, 16824949663447227068, 85795995087002057 },
    &[_]u64{ 14793711725276144220, 16494403799991899904, 10145107106505865967, 87475779699624060 },
    &[_]u64{ 15427548291869817042, 12330588654550505203, 13980791795114552342, 89188452518064298 },
    &[_]u64{ 9979404135116626552, 13477446383271537499, 14459862802511591337, 90934657454687378 },
    &[_]u64{ 12385121150303452775, 9097130814231585614, 6523855782339765207, 92715051028904201 },
    &[_]u64{ 1822931022538209743, 16062974719797586441, 3619180286173516788, 94530302614003091 },
    &[_]u64{ 12318611738248470829, 13330752208259324507, 10986694768744162601, 96381094688813589 },
    &[_]u64{ 13684493829640282333, 7674802078297225834, 15208116197624593182, 98268123094297527 },
    &[_]u64{ 5408877057066295332, 6470124174091971006, 15112713923117703147, 100192097295163851 },
    &[_]u64{ 11407083166564425062, 18189998238742408185, 4337638702446708282, 102153740646605557 },
    &[_]u64{ 4112405898036935485, 924624216579956435, 14251108172073737125, 104153790666259019 },
    &[_]u64{ 16996739107011444789, 10015944118339042475, 2395188869672266257, 106192999311487969 },
    &[_]u64{ 4588314690421337879, 5339991768263654604, 15441007590670620066, 108272133262096356 },
    &[_]u64{ 2286159977890359825, 14329706763185060248, 5980012964059367667, 110391974208576409 },
    &[_]u64{ 9654767503237031099, 11293544302844823188, 11739932712678287805, 112553319146000238 },
    &[_]u64{ 11362964448496095896, 7990659682315657680, 251480263940996374, 114756980673665505 },
    &[_]u64{ 1423410421096377129, 14274395557581462179, 16553482793602208894, 117003787300607788 },
    &[_]u64{ 2070444190619093137, 11517140404712147401, 11657844572835578076, 119294583757094535 },
    &[_]u64{ 7648316884775828921, 15264332483297977688, 247182277434709002, 121630231312217685 },
    &[_]u64{ 17410896758132241352, 10923914482914417070, 13976383996795783649, 124011608097704390 },
    &[_]u64{ 9542674537907272703, 3079432708831728956, 14235189590642919676, 126439609438067572 },
    &[_]u64{ 10364666969937261816, 8464573184892924210, 12758646866025101190, 128915148187220428 },
    &[_]u64{ 14720354822146013883, 11480204489231511423, 7449876034836187038, 131439155071681461 },
    &[_]u64{ 1692907053653558553, 17835392458598425233, 1754856712536736598, 134012579040499057 },
    &[_]u64{ 5620591334531458755, 11361776175667106627, 13350215315297937856, 136636387622027174 },
    &[_]u64{ 17455759733928092601, 10362573084069962561, 11246018728801810510, 139311567287686283 },
    &[_]u64{ 2465404073814044982, 17694822665274381860, 1509954037718722697, 142039123822846312 },
    &[_]u64{ 2152236053329638369, 11202280800589637091, 16388426812920420176, 72410041352485523 },
    &[_]u64{ 17319024055671609028, 10944982848661280484, 2457150158022562661, 73827744744583080 },
    &[_]u64{ 17511219308535248024, 5122059497846768077, 2089605804219668451, 75273205100637900 },
    &[_]u64{ 10082673333144031533, 14429008783411894887, 12842832230171903890, 76746965869337783 },
    &[_]u64{ 16196653406315961184, 10260180891682904501, 10537411930446752461, 78249581139456266 },
    &[_]u64{ 15084422041749743389, 234835370106753111, 16662517110286225617, 79781615848172976 },
    &[_]u64{ 8199644021067702606, 3787318116274991885, 7438130039325743106, 81343645993472659 },
    &[_]u64{ 12039493937039359765, 9773822153580393709, 5945428874398357806, 82936258850702722 },
    &[_]u64{ 984543865091303961, 7975107621689454830, 6556665988501773347, 84560053193370726 },
    &[_]u64{ 9633317878125234244, 16099592426808915028, 9706674539190598200, 86215639518264828 },
    &[_]u64{ 6860695058870476186, 4471839111886709592, 7828342285492709568, 87903640274981819 },
    &[_]u64{ 14583324717644598331, 4496120889473451238, 5290040788305728466, 89624690099949049 },
    &[_]u64{ 18093669366515003715, 12879506572606942994, 18005739787089675377, 91379436055028227 },
    &[_]u64{ 17997493966862379937, 14646222655265145582, 10265023312844161858, 93168537870790806 },
    &[_]u64{ 12283848109039722318, 11290258077250314935, 9878160025624946825, 94992668194556404 },
    &[_]u64{ 8087752761883078164, 5262596608437575693, 11093553063763274413, 96852512843287537 },
    &[_]u64{ 15027787746776840781, 12250273651168257752, 9290470558712181914, 98748771061435726 },
    &[_]u64{ 15003915578366724489, 2937334162439764327, 5404085603526796602, 100682155783835929 },
    &[_]u64{ 5225610465224746757, 14932114897406142027, 2774647558180708010, 102653393903748137 },
    &[_]u64{ 17112957703385190360, 12069082008339002412, 3901112447086388439, 104663226546146909 },
    &[_]u64{ 4062324464323300238, 3992768146772240329, 15757196565593695724, 106712409346361594 },
    &[_]u64{ 5525364615810306701, 11855206026704935156, 11344868740897365300, 108801712734172003 },
    &[_]u64{ 9274143661888462646, 4478365862348432381, 18010077872551661771, 110931922223466333 },
    &[_]u64{ 12604141221930060148, 8930937759942591500, 9382183116147201338, 113103838707570263 },
    &[_]u64{ 14513929377491886653, 1410646149696279084, 587092196850797612, 115318278760358235 },
    &[_]u64{ 2226851524999454362, 7717102471110805679, 7187441550995571734, 117576074943260147 },
    &[_]u64{ 5527526061344932763, 2347100676188369132, 16976241418824030445, 119878076118278875 },
    &[_]u64{ 6088479778147221611, 17669593130014777580, 10991124207197663546, 122225147767136307 },
    &[_]u64{ 11107734086759692041, 3391795220306863431, 17233960908859089158, 124618172316667879 },
    &[_]u64{ 7913172514655155198, 17726879005381242552, 641069866244011540, 127058049470587962 },
    &[_]u64{ 12596991768458713949, 15714785522479904446, 6035972567136116512, 129545696547750811 },
    &[_]u64{ 16901996933781815980, 4275085211437148707, 14091642539965169063, 132082048827034281 },
    &[_]u64{ 7524574627987869240, 15661204384239316051, 2444526454225712267, 134668059898975949 },
    &[_]u64{ 8199251625090479942, 6803282222165044067, 16064817666437851504, 137304702024293857 },
    &[_]u64{ 4453256673338111920, 15269922543084434181, 3139961729834750852, 139992966499426682 },
    &[_]u64{ 15841763546372731299, 3013174075437671812, 4383755396295695606, 142733864029230733 },
    &[_]u64{ 9771896230907310329, 4900659362437687569, 12386126719044266361, 72764212553486967 },
    &[_]u64{ 9420455527449565190, 1859606122611023693, 6555040298902684281, 74188850200884818 },
    &[_]u64{ 5146105983135678095, 2287300449992174951, 4325371679080264751, 75641380576797959 },
    &[_]u64{ 11019359372592553360, 8422686425957443718, 7175176077944048210, 77122349788024458 },
    &[_]u64{ 11005742969399620716, 4132174559240043701, 9372258443096612118, 78632314633490790 },
    &[_]u64{ 8887589641394725840, 8029899502466543662, 14582206497241572853, 80171842813591127 },
    &[_]u64{ 360247523705545899, 12568341805293354211, 14653258284762517866, 81741513143625247 },
    &[_]u64{ 12314272731984275834, 4740745023227177044, 6141631472368337539, 83341915771415304 },
    &[_]u64{ 441052047733984759, 7940090120939869826, 11750200619921094248, 84973652399183278 },
    &[_]u64{ 3436657868127012749, 9187006432149937667, 16389726097323041290, 86637336509772529 },
    &[_]u64{ 13490220260784534044, 15339072891382896702, 8846102360835316895, 88333593597298497 },
    &[_]u64{ 4125672032094859833, 158347675704003277, 10592598512749774447, 90063061402315272 },
    &[_]u64{ 12189928252974395775, 2386931199439295891, 7009030566469913276, 91826390151586454 },
    &[_]u64{ 9256479608339282969, 2844900158963599229, 11148388908923225596, 93624242802550437 },
    &[_]u64{ 11584393507658707408, 2863659090805147914, 9873421561981063551, 95457295292572042 },
    &[_]u64{ 13984297296943171390, 1931468383973130608, 12905719743235082319, 97326236793074198 },
    &[_]u64{ 5837045222254987499, 10213498696735864176, 14893951506257020749, 99231769968645227 },
};

// Unfortunately, the results are sometimes off by one or two. We use an additional
// lookup table to store those cases and adjust the result.
pub const pow5_errors = [_]u64{
    0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x9555596400000000,
    0x65a6569525565555, 0x4415551445449655, 0x5105015504144541, 0x65a69969a6965964,
    0x5054955969959656, 0x5105154515554145, 0x4055511051591555, 0x5500514455550115,
    0x0041140014145515, 0x1005440545511051, 0x0014405450411004, 0x0414440010500000,
    0x0044000440010040, 0x5551155000004001, 0x4554555454544114, 0x5150045544005441,
    0x0001111400054501, 0x6550955555554554, 0x1504159645559559, 0x4105055141454545,
    0x1411541410405454, 0x0415555044545555, 0x0014154115405550, 0x1540055040411445,
    0x0000000500000000, 0x5644000000000000, 0x1155555591596555, 0x0410440054569565,
    0x5145100010010005, 0x0555041405500150, 0x4141450455140450, 0x0000000144000140,
    0x5114004001105410, 0x4444100404005504, 0x0414014410001015, 0x5145055155555015,
    0x0141041444445540, 0x0000100451541414, 0x4105041104155550, 0x0500501150451145,
    0x1001050000004114, 0x5551504400141045, 0x5110545410151454, 0x0100001400004040,
    0x5040010111040000, 0x0140000150541100, 0x4400140400104110, 0x5011014405545004,
    0x0000000044155440, 0x0000000010000000, 0x1100401444440001, 0x0040401010055111,
    0x5155155551405454, 0x0444440015514411, 0x0054505054014101, 0x0451015441115511,
    0x1541411401140551, 0x4155104514445110, 0x4141145450145515, 0x5451445055155050,
    0x4400515554110054, 0x5111145104501151, 0x565a655455500501, 0x5565555555525955,
    0x0550511500405695, 0x4415504051054544, 0x6555595965555554, 0x0100915915555655,
    0x5540001510001001, 0x5450051414000544, 0x1405010555555551, 0x5555515555644155,
    0x5555055595496555, 0x5451045004415000, 0x5450510144040144, 0x5554155555556455,
    0x5051555495415555, 0x5555554555555545, 0x0000000010005455, 0x4000005000040000,
    0x5565555555555954, 0x5554559555555505, 0x9645545495552555, 0x4000400055955564,
    0x0040000000000001, 0x4004100100000000, 0x5540040440000411, 0x4565555955545644,
    0x1140659549651556, 0x0100000410010000, 0x5555515400004001, 0x5955545555155255,
    0x5151055545505556, 0x5051454510554515, 0x0501500050415554, 0x5044154005441005,
    0x1455445450550455, 0x0010144055144545, 0x0000401100000004, 0x1050145050000010,
    0x0415004554011540, 0x1000510100151150, 0x0100040400001144, 0x0000000000000000,
    0x0550004400000100, 0x0151145041451151, 0x0000400400005450, 0x0000100044010004,
    0x0100054100050040, 0x0504400005410010, 0x4011410445500105, 0x0000404000144411,
    0x0101504404500000, 0x0000005044400400, 0x0000000014000100, 0x0404440414000000,
    0x5554100410000140, 0x4555455544505555, 0x5454105055455455, 0x0115454155454015,
    0x4404110000045100, 0x4400001100101501, 0x6596955956966a94, 0x0040655955665965,
    0x5554144400100155, 0xa549495401011041, 0x5596555565955555, 0x5569965959549555,
    0x969565a655555456, 0x0000001000000000, 0x0000000040000140, 0x0000040100000000,
    0x1415454400000000, 0x5410415411454114, 0x0400040104000154, 0x0504045000000411,
    0x0000001000000010, 0x5554000000001040, 0x5549155551556595, 0x1455541055515555,
    0x0510555454554541, 0x9555555555540455, 0x6455456555556465, 0x4524565555654514,
    0x5554655255559545, 0x9555455441155556, 0x0000000051515555, 0x0010005040000550,
    0x5044044040000000, 0x1045040440010500, 0x0000400000040000, 0x0000000000000000,
};

pub const generic_pow5_inv_split = [_][]const u64{
    &[_]u64{ 0, 0, 0, 144115188075855872 },
    &[_]u64{ 1573859546583440065, 2691002611772552616, 6763753280790178510, 141347765182270746 },
    &[_]u64{ 12960290449513840412, 12345512957918226762, 18057899791198622765, 138633484706040742 },
    &[_]u64{ 7615871757716765416, 9507132263365501332, 4879801712092008245, 135971326161092377 },
    &[_]u64{ 7869961150745287587, 5804035291554591636, 8883897266325833928, 133360288657597085 },
    &[_]u64{ 2942118023529634767, 15128191429820565086, 10638459445243230718, 130799390525667397 },
    &[_]u64{ 14188759758411913794, 5362791266439207815, 8068821289119264054, 128287668946279217 },
    &[_]u64{ 7183196927902545212, 1952291723540117099, 12075928209936341512, 125824179589281448 },
    &[_]u64{ 5672588001402349748, 17892323620748423487, 9874578446960390364, 123407996258356868 },
    &[_]u64{ 4442590541217566325, 4558254706293456445, 10343828952663182727, 121038210542800766 },
    &[_]u64{ 3005560928406962566, 2082271027139057888, 13961184524927245081, 118713931475986426 },
    &[_]u64{ 13299058168408384786, 17834349496131278595, 9029906103900731664, 116434285200389047 },
    &[_]u64{ 5414878118283973035, 13079825470227392078, 17897304791683760280, 114198414639042157 },
    &[_]u64{ 14609755883382484834, 14991702445765844156, 3269802549772755411, 112005479173303009 },
    &[_]u64{ 15967774957605076027, 2511532636717499923, 16221038267832563171, 109854654326805788 },
    &[_]u64{ 9269330061621627145, 3332501053426257392, 16223281189403734630, 107745131455483836 },
    &[_]u64{ 16739559299223642282, 1873986623300664530, 6546709159471442872, 105676117443544318 },
    &[_]u64{ 17116435360051202055, 1359075105581853924, 2038341371621886470, 103646834405281051 },
    &[_]u64{ 17144715798009627550, 3201623802661132408, 9757551605154622431, 101656519392613377 },
    &[_]u64{ 17580479792687825857, 6546633380567327312, 15099972427870912398, 99704424108241124 },
    &[_]u64{ 9726477118325522902, 14578369026754005435, 11728055595254428803, 97789814624307808 },
    &[_]u64{ 134593949518343635, 5715151379816901985, 1660163707976377376, 95911971106466306 },
    &[_]u64{ 5515914027713859358, 7124354893273815720, 5548463282858794077, 94070187543243255 },
    &[_]u64{ 6188403395862945512, 5681264392632320838, 15417410852121406654, 92263771480600430 },
    &[_]u64{ 15908890877468271457, 10398888261125597540, 4817794962769172309, 90492043761593298 },
    &[_]u64{ 1413077535082201005, 12675058125384151580, 7731426132303759597, 88754338271028867 },
    &[_]u64{ 1486733163972670293, 11369385300195092554, 11610016711694864110, 87050001685026843 },
    &[_]u64{ 8788596583757589684, 3978580923851924802, 9255162428306775812, 85378393225389919 },
    &[_]u64{ 7203518319660962120, 15044736224407683725, 2488132019818199792, 83738884418690858 },
    &[_]u64{ 4004175967662388707, 18236988667757575407, 15613100370957482671, 82130858859985791 },
    &[_]u64{ 18371903370586036463, 53497579022921640, 16465963977267203307, 80553711981064899 },
    &[_]u64{ 10170778323887491315, 1999668801648976001, 10209763593579456445, 79006850823153334 },
    &[_]u64{ 17108131712433974546, 16825784443029944237, 2078700786753338945, 77489693813976938 },
    &[_]u64{ 17221789422665858532, 12145427517550446164, 5391414622238668005, 76001670549108934 },
    &[_]u64{ 4859588996898795878, 1715798948121313204, 3950858167455137171, 74542221577515387 },
    &[_]u64{ 13513469241795711526, 631367850494860526, 10517278915021816160, 73110798191218799 },
    &[_]u64{ 11757513142672073111, 2581974932255022228, 17498959383193606459, 143413724438001539 },
    &[_]u64{ 14524355192525042817, 5640643347559376447, 1309659274756813016, 140659771648132296 },
    &[_]u64{ 2765095348461978538, 11021111021896007722, 3224303603779962366, 137958702611185230 },
    &[_]u64{ 12373410389187981037, 13679193545685856195, 11644609038462631561, 135309501808182158 },
    &[_]u64{ 12813176257562780151, 3754199046160268020, 9954691079802960722, 132711173221007413 },
    &[_]u64{ 17557452279667723458, 3237799193992485824, 17893947919029030695, 130162739957935629 },
    &[_]u64{ 14634200999559435155, 4123869946105211004, 6955301747350769239, 127663243886350468 },
    &[_]u64{ 2185352760627740240, 2864813346878886844, 13049218671329690184, 125211745272516185 },
    &[_]u64{ 6143438674322183002, 10464733336980678750, 6982925169933978309, 122807322428266620 },
    &[_]u64{ 1099509117817174576, 10202656147550524081, 754997032816608484, 120449071364478757 },
    &[_]u64{ 2410631293559367023, 17407273750261453804, 15307291918933463037, 118136105451200587 },
    &[_]u64{ 12224968375134586697, 1664436604907828062, 11506086230137787358, 115867555084305488 },
    &[_]u64{ 3495926216898000888, 18392536965197424288, 10992889188570643156, 113642567358547782 },
    &[_]u64{ 8744506286256259680, 3966568369496879937, 18342264969761820037, 111460305746896569 },
    &[_]u64{ 7689600520560455039, 5254331190877624630, 9628558080573245556, 109319949786027263 },
    &[_]u64{ 11862637625618819436, 3456120362318976488, 14690471063106001082, 107220694767852583 },
    &[_]u64{ 5697330450030126444, 12424082405392918899, 358204170751754904, 105161751436977040 },
    &[_]u64{ 11257457505097373622, 15373192700214208870, 671619062372033814, 103142345693961148 },
    &[_]u64{ 16850355018477166700, 1913910419361963966, 4550257919755970531, 101161718304283822 },
    &[_]u64{ 9670835567561997011, 10584031339132130638, 3060560222974851757, 99219124612893520 },
    &[_]u64{ 7698686577353054710, 11689292838639130817, 11806331021588878241, 97313834264240819 },
    &[_]u64{ 12233569599615692137, 3347791226108469959, 10333904326094451110, 95445130927687169 },
    &[_]u64{ 13049400362825383933, 17142621313007799680, 3790542585289224168, 93612312028186576 },
    &[_]u64{ 12430457242474442072, 5625077542189557960, 14765055286236672238, 91814688482138969 },
    &[_]u64{ 4759444137752473128, 2230562561567025078, 4954443037339580076, 90051584438315940 },
    &[_]u64{ 7246913525170274758, 8910297835195760709, 4015904029508858381, 88322337023761438 },
    &[_]u64{ 12854430245836432067, 8135139748065431455, 11548083631386317976, 86626296094571907 },
    &[_]u64{ 4848827254502687803, 4789491250196085625, 3988192420450664125, 84962823991462151 },
    &[_]u64{ 7435538409611286684, 904061756819742353, 14598026519493048444, 83331295300025028 },
    &[_]u64{ 11042616160352530997, 8948390828345326218, 10052651191118271927, 81731096615594853 },
    &[_]u64{ 11059348291563778943, 11696515766184685544, 3783210511290897367, 80161626312626082 },
    &[_]u64{ 7020010856491885826, 5025093219346041680, 8960210401638911765, 78622294318500592 },
    &[_]u64{ 17732844474490699984, 7820866704994446502, 6088373186798844243, 77112521891678506 },
    &[_]u64{ 688278527545590501, 3045610706602776618, 8684243536999567610, 75631741404109150 },
    &[_]u64{ 2734573255120657297, 3903146411440697663, 9470794821691856713, 74179396127820347 },
    &[_]u64{ 15996457521023071259, 4776627823451271680, 12394856457265744744, 72754940025605801 },
    &[_]u64{ 13492065758834518331, 7390517611012222399, 1630485387832860230, 142715675091463768 },
    &[_]u64{ 13665021627282055864, 9897834675523659302, 17907668136755296849, 139975126841173266 },
    &[_]u64{ 9603773719399446181, 10771916301484339398, 10672699855989487527, 137287204938390542 },
    &[_]u64{ 3630218541553511265, 8139010004241080614, 2876479648932814543, 134650898807055963 },
    &[_]u64{ 8318835909686377084, 9525369258927993371, 2796120270400437057, 132065217277054270 },
    &[_]u64{ 11190003059043290163, 12424345635599592110, 12539346395388933763, 129529188211565064 },
    &[_]u64{ 8701968833973242276, 820569587086330727, 2315591597351480110, 127041858141569228 },
    &[_]u64{ 5115113890115690487, 16906305245394587826, 9899749468931071388, 124602291907373862 },
    &[_]u64{ 15543535488939245974, 10945189844466391399, 3553863472349432246, 122209572307020975 },
    &[_]u64{ 7709257252608325038, 1191832167690640880, 15077137020234258537, 119862799751447719 },
    &[_]u64{ 7541333244210021737, 9790054727902174575, 5160944773155322014, 117561091926268545 },
    &[_]u64{ 12297384708782857832, 1281328873123467374, 4827925254630475769, 115303583460052092 },
    &[_]u64{ 13243237906232367265, 15873887428139547641, 3607993172301799599, 113089425598968120 },
    &[_]u64{ 11384616453739611114, 15184114243769211033, 13148448124803481057, 110917785887682141 },
    &[_]u64{ 17727970963596660683, 1196965221832671990, 14537830463956404138, 108787847856377790 },
    &[_]u64{ 17241367586707330931, 8880584684128262874, 11173506540726547818, 106698810713789254 },
    &[_]u64{ 7184427196661305643, 14332510582433188173, 14230167953789677901, 104649889046128358 },
};

pub const pow5_inv_errors = [_]u64{
    0x1144155514145504, 0x0000541555401141, 0x0000000000000000, 0x0154454000000000,
    0x4114105515544440, 0x0001001111500415, 0x4041411410011000, 0x5550114515155014,
    0x1404100041554551, 0x0515000450404410, 0x5054544401140004, 0x5155501005555105,
    0x1144141000105515, 0x0541500000500000, 0x1104105540444140, 0x4000015055514110,
    0x0054010450004005, 0x4155515404100005, 0x5155145045155555, 0x1511555515440558,
    0x5558544555515555, 0x0000000000000010, 0x5004000000000050, 0x1415510100000010,
    0x4545555444514500, 0x5155151555555551, 0x1441540144044554, 0x5150104045544400,
    0x5450545401444040, 0x5554455045501400, 0x4655155555555145, 0x1000010055455055,
    0x1000004000055004, 0x4455405104000005, 0x4500114504150545, 0x0000000014000000,
    0x5450000000000000, 0x5514551511445555, 0x4111501040555451, 0x4515445500054444,
    0x5101500104100441, 0x1545115155545055, 0x0000000000000000, 0x1554000000100000,
    0x5555545595551555, 0x5555051851455955, 0x5555555555555559, 0x0000400011001555,
    0x0000004400040000, 0x5455511555554554, 0x5614555544115445, 0x6455156145555155,
    0x5455855455415455, 0x5515555144555545, 0x0114400000145155, 0x0000051000450511,
    0x4455154554445100, 0x4554150141544455, 0x65955555559a5965, 0x5555555854559559,
    0x9569654559616595, 0x1040044040005565, 0x1010010500011044, 0x1554015545154540,
    0x4440555401545441, 0x1014441450550105, 0x4545400410504145, 0x5015111541040151,
    0x5145051154000410, 0x1040001044545044, 0x4001400000151410, 0x0540000044040000,
    0x0510555454411544, 0x0400054054141550, 0x1001041145001100, 0x0000000140000000,
    0x0000000014100000, 0x1544005454000140, 0x4050055505445145, 0x0011511104504155,
    0x5505544415045055, 0x1155154445515554, 0x0000000000004555, 0x0000000000000000,
    0x5101010510400004, 0x1514045044440400, 0x5515519555515555, 0x4554545441555545,
    0x1551055955551515, 0x0150000011505515, 0x0044005040400000, 0x0004001004010050,
    0x0000051004450414, 0x0114001101001144, 0x0401000001000001, 0x4500010001000401,
    0x0004100000005000, 0x0105000441101100, 0x0455455550454540, 0x5404050144105505,
    0x4101510540555455, 0x1055541411451555, 0x5451445110115505, 0x1154110010101545,
    0x1145140450054055, 0x5555565415551554, 0x1550559555555555, 0x5555541545045141,
    0x4555455450500100, 0x5510454545554555, 0x1510140115045455, 0x1001050040111510,
    0x5555454555555504, 0x9954155545515554, 0x6596656555555555, 0x0140410051555559,
    0x0011104010001544, 0x965669659a680501, 0x5655a55955556955, 0x4015111014404514,
    0x1414155554505145, 0x0540040011051404, 0x1010000000015005, 0x0010054050004410,
    0x5041104014000100, 0x4440010500100001, 0x1155510504545554, 0x0450151545115541,
    0x4000100400110440, 0x1004440010514440, 0x0000115050450000, 0x0545404455541500,
    0x1051051555505101, 0x5505144554544144, 0x4550545555515550, 0x0015400450045445,
    0x4514155400554415, 0x4555055051050151, 0x1511441450001014, 0x4544554510404414,
    0x4115115545545450, 0x5500541555551555, 0x5550010544155015, 0x0144414045545500,
    0x4154050001050150, 0x5550511111000145, 0x1114504055000151, 0x5104041101451040,
    0x0010501401051441, 0x0010501450504401, 0x4554585440044444, 0x5155555951450455,
    0x0040000400105555, 0x0000000000000001,
};

// Computes 5^i in the form required by Ryu, and stores it in the given pointer.
pub fn computePow5(i: u32, result: []u64) void {
    const base = i / generic_pow5_table.len;
    const base2 = base * generic_pow5_table.len;
    const mul = generic_pow5_split[base];
    if (i == base2) {
        result[0] = mul[0];
        result[1] = mul[1];
        result[2] = mul[2];
        result[3] = mul[3];
    } else {
        const offset = i - base2;
        const m = generic_pow5_table[offset];
        const delta = helper.pow5Bits(@intCast(i32, i)) - helper.pow5Bits(@intCast(i32, base2));
        const corr = @intCast(u32, (pow5_errors[i / 32] >> @intCast(u6, (2 * (i % 32)))) & 3);
        helper.mul_128_256_shift(m, mul, delta, corr, result);
    }
}

// Computes 5^-i in the form required by Ryu, and stores it in the given pointer.
pub fn computeInvPow5(i: u32, result: []u64) void {
    const base = (i + generic_pow5_table.len - 1) / generic_pow5_table.len;
    const base2 = base * generic_pow5_table.len;
    const mul = generic_pow5_inv_split[base]; // 1/5^base2
    if (i == base2) {
        result[0] = mul[0] + 1;
        result[1] = mul[1];
        result[2] = mul[2];
        result[3] = mul[3];
    } else {
        const offset = base2 - i;
        const m = generic_pow5_table[offset]; // 5^offset
        const delta = helper.pow5Bits(@intCast(i32, base2)) - helper.pow5Bits(@intCast(i32, i));
        const corr = @intCast(u32, ((pow5_inv_errors[i / 32] >> @intCast(u6, (2 * (i % 32)))) & 3) + 1);
        helper.mul_128_256_shift(m, mul, delta, corr, result);
    }
}

const assert = std.debug.assert;

const EXACT_POW5_IDS = [_]u32{
    1, 10, 55, 56, 300, 1000, 2345, 3210, 4968 - 3, 4968 - 1,
};

const EXACT_POW5 = [_][]const u64{
    &[_]u64{ 0, 0, 0, 90071992547409920 },
    &[_]u64{ 0, 0, 0, 83886080000000000 },
    &[_]u64{ 0, 15708555500268290048, 14699724349295723422, 117549435082228750 },
    &[_]u64{ 0, 5206161169240293376, 4575641699882439235, 73468396926392969 },
    &[_]u64{ 2042133660145364371, 9702060195405861314, 6467325284806654637, 107597969523956154 },
    &[_]u64{ 15128847313296546509, 11916317791371073891, 788593023170869613, 137108429762886488 },
    &[_]u64{ 10998857860460266920, 858411415306315808, 12732466392391605111, 136471991906002539 },
    &[_]u64{ 5404652432687674341, 18039986361557197657, 2228774284272261859, 94370442653226447 },
    &[_]u64{ 15313487127299642753, 9780770376910163681, 15213531439620567348, 93317108016191349 },
    &[_]u64{ 7928436552078881485, 723697829319983520, 932817143438521969, 72903990637649492 },
};
const EXACT_INV_POW5_IDS = [_]u32{
    10, 55, 56, 300, 1000, 2345, 3210, 4897 - 3, 4897 - 1,
};

const EXACT_INV_POW5 = [_][]const u64{
    &[_]u64{ 13362655651931650467, 3917988799323120213, 9037289074543890586, 123794003928538027 },
    &[_]u64{ 983662216614650042, 15516934687640009097, 8839031818921249472, 88342353238919216 },
    &[_]u64{ 1573859546583440066, 2691002611772552616, 6763753280790178510, 141347765182270746 },
    &[_]u64{ 1607391579053635167, 943946735193622172, 10726301928680150504, 96512915280967053 },
    &[_]u64{ 7238603269427345471, 17319296798264127544, 14852913523241959878, 75740009093741608 },
    &[_]u64{ 2734564866961569744, 13277212449690943834, 17231454566843360565, 76093223027199785 },
    &[_]u64{ 5348945211244460332, 14119936934335594321, 15647307321253222579, 110040743956546595 },
    &[_]u64{ 2848579222248330872, 15087265905644220040, 4449739884766224405, 100774177495370196 },
    &[_]u64{ 1432572115632717323, 9719393440895634811, 3482057763655621045, 128990947194073851 },
};

test "ryu128.tables generic_computePow5" {
    var i: usize = 0;
    while (i < 10) : (i += 1) {
        var result: [4]u64 = undefined;

        computePow5(EXACT_POW5_IDS[i], result[0..]);
        assert(EXACT_POW5[i][0] == result[0]);
        assert(EXACT_POW5[i][1] == result[1]);
        assert(EXACT_POW5[i][2] == result[2]);
        assert(EXACT_POW5[i][3] == result[3]);
    }
}

test "ryu128.tables generic_computeInvPow5" {
    var i: usize = 0;
    while (i < 9) : (i += 1) {
        var result: [4]u64 = undefined;

        computeInvPow5(EXACT_INV_POW5_IDS[i], result[0..]);
        assert(EXACT_INV_POW5[i][0] == result[0]);
        assert(EXACT_INV_POW5[i][1] == result[1]);
        assert(EXACT_INV_POW5[i][2] == result[2]);
        assert(EXACT_INV_POW5[i][3] == result[3]);
    }
}
